<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimberly's Dropathon - 75 Days of Creative Output</title>
    <meta name="description" content="Join Kimberly's 75-day creative challenge. Beating back perfectionism one drop at a time.">
    <meta name="theme-color" content="#1a0f26">
    <meta name="robots" content="index, follow">

    
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://www.gstatic.com https://cdn.tailwindcss.com 'unsafe-inline';
        style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
        font-src 'self' https://fonts.gstatic.com data:;
        img-src 'self' https: data:;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com;
        frame-src 'self' https://kimberlynfoster.substack.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self' https:;
        upgrade-insecure-requests;
    ">

    <link rel="canonical" href="https://knf.kim/drops">
    <meta property="og:title" content="Kimberly's Dropathon - 75 Days of Creative Output">
    <meta property="og:description" content="Join Kimberly's 75-day creative challenge. Beating back perfectionism one drop at a time.">
    <meta property="og:image" content="https://knfoster13.github.io/HQ/kdrop6.png">
    <meta property="og:image:alt" content="Kimberly's 75-day Dropathon">
    <meta property="og:url" content="https://knf.kim/drops">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Kimberly's Dropathon">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Kimberly's Dropathon - 75 Days of Creative Output">
    <meta name="twitter:description" content="Join Kimberly's 75-day creative challenge. Beating back perfectionism one drop at a time.">
    <meta name="twitter:image" content="https://knfoster13.github.io/HQ/kdrop6.png">
    <meta name="twitter:creator" content="@kimberlynfoster">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Kimberly's Dropathon",
      "description": "75 Days of Creative Output",
      "url": "https://knf.kim/drops",
      "publisher": {
        "@type": "Person",
        "name": "Kimberly Nicole Foster"
      }
    }
    </script>
    <script type="application/ld+json" id="itemListSchema"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preload" href="https://knfoster13.github.io/HQ/kdrop4.png" as="image" fetchpriority="high">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --bg-dark: #1a0f26;
        --bg-center: #2d1b42;
        --bg-edge: #241538;
        --surface: rgba(42, 26, 61, 0.85);
        --surface-hover: rgba(52, 36, 71, 0.95);
        --accent: #a78bfa;
        --accent-bright: #c4b5fd;
        --accent-start: #C6B6F7;   /* a soft lavender */
        --accent-end:   #FFD9C0;     /* a warm peach */
        --cta: #f472b6;
        --cta-hover: #ec4899;
        --text-primary: #FFFFF0;   /* Ivory */
        --text-secondary: #E0D8CC; /* Lighter warm gray */
        --text-muted: #B0A89F;   /* Lighter muted tone */
        --tag-free: #86efac;
        --tag-paid: #fde047;
        --heart: #f472b6;
        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;
        --border-color: rgba(167, 139, 250, 0.15);
        --border-color-hover: rgba(167, 139, 250, 0.3);
      }

      /* Base & Typography */
      html { scroll-behavior: smooth; }
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: radial-gradient(ellipse at top center, var(--bg-center), var(--bg-edge));
        min-height: 100vh;
        color: var(--text-primary);
        line-height: 1.75;
        transition: all 0.3s ease;
      }
      .brand-font { font-family: 'DM Serif Display', serif; }
      .line-clamp-2 {
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      }
      .text-gradient {
        background: linear-gradient(to right, var(--accent-start), var(--accent-end));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      /* Accessibility */
      *:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 0.25rem; }
      .skip-to-content { position: absolute; top: -40px; left: 0; background: var(--accent); color: white; padding: 8px; text-decoration: none; z-index: 1000; border-radius: 0 0 0.5rem 0; }
      .skip-to-content:focus { top: 0; }

      /* Components */
       .frosted-header {
        background-color: rgba(26, 15, 38, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 0.75rem; /* rounded-xl */
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      }
      .card:hover {
        transform: translateY(-5px);
        background: var(--surface-hover);
        border-color: var(--border-color-hover);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      }
      .btn {
        font-weight: 600; padding: 0.625rem 1.5rem; border-radius: 9999px;
        transition: all 0.3s ease; border: none; cursor: pointer;
        display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      }
      .btn-primary { background: linear-gradient(135deg, var(--cta) 0%, var(--cta-hover) 100%); color: white; }
      .btn-primary:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 10px 25px rgba(244, 114, 182, 0.3); }
      .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); }
      .btn-secondary { background: rgba(167, 139, 250, 0.1); color: var(--accent-bright); border: 1px solid rgba(167, 139, 250, 0.3); }
      .btn-secondary:hover:not(:disabled) { background: rgba(167, 139, 250, 0.2); border-color: rgba(167, 139, 250, 0.5); }
      .btn-peach {
        background-color: var(--accent-end);
        color: #5d422d; /* Darker text for contrast */
      }
      .btn-peach:hover:not(:disabled) {
        background-color: #ffc7a1; /* Lighter peach on hover */
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(255, 217, 192, 0.3);
      }
      .form-input {
        background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(167, 139, 250, 0.2);
        color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem;
        width: 100%; transition: all 0.2s ease;
      }
      .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1); }
      .form-input.error { border-color: var(--error); }
      .tag { 
        font-size: 0.875rem; 
        font-weight: 600; 
        padding: 0.375rem 1rem; 
        border-radius: 9999px;
      }
      .tag-free { 
        background: rgba(134, 239, 172, 0.15); 
        color: var(--tag-free); 
        border: 1px solid rgba(134, 239, 172, 0.3);
        box-shadow: 0 0 10px rgba(134, 239, 172, 0.2);
      }
      .tag-paid { 
        background: rgba(253, 224, 71, 0.15); 
        color: var(--tag-paid); 
        border: 1px solid rgba(253, 224, 71, 0.3);
        box-shadow: 0 0 10px rgba(253, 224, 71, 0.2);
      }
      .title-glow {
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      
      /* Heart Animation */
      .heart-btn { transition: all 0.2s ease; cursor: pointer; user-select: none; }
      .heart-btn:hover svg { transform: scale(1.1); }
      .heart-btn.hearted svg { fill: var(--heart); stroke: var(--heart); animation: heartPulse 0.3s ease; }
      @keyframes heartPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
      
      /* Progress Bar */
      .header-progress-bar { 
        height: 0.75rem; /* h-3 */
        background-color: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 9999px;
        overflow: hidden;
      }
      .header-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-start) 0%, var(--accent-end) 100%);
        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        animation: progressShimmer 2s ease-in-out infinite;
        box-shadow: 0 0 8px var(--accent-start);
      }

      @keyframes progressShimmer {
          0% { opacity: 0.7; }
          50% { opacity: 1; }
          100% { opacity: 0.7; }
      }

      /* Toast Notifications */
      .toast {
        position: fixed; bottom: 2rem; left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--surface); color: var(--text-primary); padding: 1rem 1.5rem;
        border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 1000;
        display: flex; align-items: center; gap: 0.75rem;
        border: 1px solid var(--border-color);
      }
      .toast.show { transform: translateY(0); opacity: 1; }
      .toast.error { border-color: var(--error); }
      .toast.warning { border-color: var(--warning); }

      /* Spinners & Skeletons */
      .loading-spinner { border: 2px solid rgba(167, 139, 250, 0.2); border-radius: 50%; border-top: 2px solid var(--accent); width: 20px; height: 20px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .skeleton-card { background: var(--surface); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
      .skeleton-line { height: 1rem; margin-bottom: 0.5rem; background: linear-gradient(90deg, rgba(167, 139, 250, 0.1) 0%, rgba(167, 139, 250, 0.2) 50%, rgba(167, 139, 250, 0.1) 100%); background-size: 200% 100%; animation: shimmer 1.5s ease-in-out infinite; border-radius: 0.25rem; }
      @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
       .filter-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid rgba(167, 139, 250, 0.2);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .filter-btn:hover {
            background: rgba(167, 139, 250, 0.1);
            border-color: rgba(167, 139, 250, 0.3);
        }

        .filter-btn.active {
            background: rgba(167, 139, 250, 0.2);
            color: var(--accent-bright);
            border-color: var(--accent);
        }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
      ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-bright); }
    </style>
</head>
<body class="bg-bg-dark">
    <a href="#content-feed" class="skip-to-content">Skip to content</a>

    <header class="sticky top-0 z-50 frosted-header" role="banner">
        <nav class="max-w-6xl mx-auto px-4 pt-3 pb-3" aria-label="Primary">
            <div class="flex items-center justify-between">
                <a href="#" class="flex items-center gap-3" aria-label="Dropathon Home">
                    <img src="LARGE-PASTEL-1.png" alt="Logo" class="h-11 w-auto">
                    <span class="hidden sm:inline font-bold text-xl brand-font text-gradient" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">Kimberly's Creative Dash</span>
                </a>
                
                <div class="hidden md:flex items-center gap-8 text-center">
                    <div class="flex flex-col-reverse">
                        <span class="text-xs uppercase tracking-wider text-muted">Day of 75</span>
                        <span id="header-day" class="text-lg font-bold">1</span>
                    </div>
                    <div class="flex flex-col-reverse">
                        <span class="text-xs uppercase tracking-wider text-muted">Drops</span>
                        <span id="header-drops" class="text-lg font-bold">0</span>
                    </div>
                    <div class="flex flex-col-reverse">
                        <span class="text-xs uppercase tracking-wider text-muted">Streak</span>
                        <span id="header-streak" class="text-lg font-bold">0</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="admin-signin-btn" class="btn btn-secondary px-4" title="Admin sign in" aria-label="Admin sign in">
                        Admin
                    </button>
                    
                    <button id="admin-signout-btn" class="btn btn-secondary px-4 hidden" title="Admin sign out" aria-label="Admin sign out">
                         Sign Out
                    </button>
                    
                    <button id="subscribe-btn" class="btn btn-peach" aria-label="Subscribe to updates">
                        <span class="hidden sm:inline">Subscribe</span>
                    </button>
                </div>
            </div>
            <div id="header-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="75" aria-valuenow="1" class="w-full mt-3 header-progress-bar">
                <div class="header-progress-fill" style="width: 1%;"></div>
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8" role="main" id="main-content">
        <section class="text-center py-12" aria-labelledby="hero-title">
            <img src="https://knfoster13.github.io/HQ/kdrop4.png" alt="Kimberly's Dropathon" class="mx-auto w-full max-w-md mb-6" width="1024" height="768" fetchpriority="high" decoding="async" loading="eager">
            <h1 id="hero-title" class="text-3xl md:text-4xl font-bold mb-4 brand-font text-gradient">Beating back perfectionism one drop at a time.</h1>
            <p class="text-lg text-muted mb-2"><span id="challenge-dates">September 13 â€” November 26, 2025</span></p>
            
            <div id="day-dots-container" class="flex gap-0.5 overflow-x-auto max-w-full py-2 px-4"></div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 max-w-2xl mx-auto" role="region" aria-label="Challenge statistics">
                <div class="card p-4 text-center"><div class="text-2xl font-bold text-accent" id="today-count" aria-live="polite">0</div><div class="text-sm text-muted">Today's Drops</div></div>
                <div class="card p-4 text-center"><div class="text-2xl font-bold text-cta" id="streak-count" aria-live="polite">0</div><div class="text-sm text-muted">Day Streak</div></div>
                <div class="card p-4 text-center"><div class="text-2xl font-bold text-success" id="free-count" aria-live="polite">0</div><div class="text-sm text-muted">Free Content</div></div>
                <div class="card p-4 text-center"><div class="text-2xl font-bold text-warning" id="paid-count" aria-live="polite">0</div><div class="text-sm text-muted">Premium</div></div>
            </div>
        </section>

        <section id="admin-panel" class="hidden mb-8 transition-all duration-500" aria-label="Admin panel">
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Add or Edit Drop</h2>
                <form id="drop-form" class="space-y-4" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="drop-title" class="block text-sm font-medium mb-1">Title *</label><input type="text" id="drop-title" class="form-input" required maxlength="200" aria-required="true"><span class="text-xs text-red-400 hidden mt-1" id="title-error"></span></div>
                        <div><label for="drop-type" class="block text-sm font-medium mb-1">Content Type *</label><select id="drop-type" class="form-input" aria-required="true"><option>Video</option><option>Podcast</option><option>Essay</option><option>Social Post</option><option>Newsletter</option><option>Tutorial</option><option>Other</option></select></div>
                    </div>
                    <div><label for="drop-description" class="block text-sm font-medium mb-1">Description *</label><textarea id="drop-description" class="form-input" rows="2" required maxlength="500" aria-required="true"></textarea><span class="text-xs text-red-400 hidden mt-1" id="description-error"></span></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="drop-link" class="block text-sm font-medium mb-1">Link *</label><input type="url" id="drop-link" class="form-input" required aria-required="true"><span class="text-xs text-red-400 hidden mt-1" id="link-error"></span></div>
                        <div><label for="drop-image" class="block text-sm font-medium mb-1">Image URL</label><input type="url" id="drop-image" class="form-input"><span class="text-xs text-red-400 hidden mt-1" id="image-error"></span></div>
                        <div><label for="drop-access" class="block text-sm font-medium mb-1">Access Level</label><select id="drop-access" class="form-input"><option>Free</option><option>Paid</option></select></div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/10"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="schedule-toggle" class="form-checkbox h-4 w-4 rounded bg-white/10 border-white/20 text-accent focus:ring-accent"><span class="text-sm font-medium">Schedule for later</span></label></div>
                    <div id="schedule-options" class="hidden grid grid-cols-2 gap-4">
                        <div><label for="schedule-date" class="block text-sm font-medium mb-1">Date</label><input type="date" id="schedule-date" class="form-input"></div>
                        <div><label for="schedule-time" class="block text-sm font-medium mb-1">Time (Local)</label><input type="time" id="schedule-time" class="form-input"></div>
                    </div>
                    
                    <div class="flex items-center gap-4 pt-2">
                        <button type="submit" id="publish-btn" class="btn btn-primary" disabled><span class="loading-spinner hidden"></span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg><span id="publish-btn-text">Drop It!</span></button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary hidden">Cancel Edit</button>
                        <button type="button" id="clear-data-btn" class="btn btn-secondary !bg-red-500/10 !text-red-400 !border-red-500/20 ml-auto">Clear All Data</button>
                    </div>
                </form>
            </div>
            <div id="scheduled-section" class="hidden mt-8">
                <h3 class="text-xl font-bold mb-4 brand-font text-gradient">Scheduled Drops</h3>
                <div id="scheduled-drops" class="space-y-4"></div>
            </div>
        </section>

        <section class="mb-6" aria-label="Search, filter and sort drops">
            <div class="card p-4">
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="relative md:col-span-1">
                        <input type="text" id="search-input" class="form-input pl-10" placeholder="Search drops..." aria-label="Search drops">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center gap-2 justify-between md:col-span-2">
                        <div class="flex gap-2 flex-wrap" role="group" aria-label="Filter options">
                            <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
                            <button class="filter-btn" data-filter="Video" aria-pressed="false">Videos</button>
                            <button class="filter-btn" data-filter="Podcast" aria-pressed="false">Podcasts</button>
                            <button class="filter-btn" data-filter="Essay" aria-pressed="false">Essays</button>
                        </div>
                        <select id="sort-select" class="form-input w-36" aria-label="Sort drops">
                            <option value="newest">Newest</option>
                            <option value="oldest">Oldest</option>
                            <option value="most-loved">Most Loved</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <section id="content-feed" class="space-y-8" aria-label="Content feed" aria-busy="true">
            <div id="skeleton-loaders">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 brand-font animate-pulse">Loading drops...</h2>
                <div class="space-y-6">
                    <div class="skeleton-card"><div class="flex flex-col md:flex-row gap-4"><div class="md:w-48 h-32 skeleton-line rounded-lg"></div><div class="flex-1 space-y-2"><div class="skeleton-line w-3/4"></div><div class="skeleton-line w-1/2"></div><div class="skeleton-line w-full"></div></div></div></div>
                    <div class="skeleton-card"><div class="flex flex-col md:flex-row gap-4"><div class="md:w-48 h-32 skeleton-line rounded-lg"></div><div class="flex-1 space-y-2"><div class="skeleton-line w-3/4"></div><div class="skeleton-line w-1/2"></div><div class="skeleton-line w-full"></div></div></div></div>
                </div>
            </div>
            
            <div id="today-section" class="hidden"><h2 class="text-2xl md:text-3xl font-bold mb-4 flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-white brand-font text-gradient">Today's Drops</span></h2><div id="today-drops" class="grid gap-6"></div></div>
            <div id="previous-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4 brand-font text-gradient">Previous Drops</h2>
                <div id="previous-drops" class="grid gap-6"></div>
                <div id="load-more-container" class="text-center mt-8"></div>
            </div>
            
            <div id="empty-state" class="text-center py-12 hidden"><svg class="w-24 h-24 mx-auto mb-4 text-muted opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg><p class="text-lg text-muted" id="empty-state-message">No drops yet. Check back soon!</p></div>
        </section>
        
        <nav class="mt-12" aria-label="Quick links">
            <h2 class="text-2xl font-bold mb-6 text-center brand-font text-gradient">Quick Links</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
                <a href="https://www.patreon.com/kimberlynfoster" class="card p-6 flex items-center gap-4 hover:scale-105" rel="noopener noreferrer" target="_blank">
                    <div class="p-3 rounded-full bg-pink-500/20">
                        <svg class="w-6 h-6 text-pink-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="font-semibold">Support on Patreon</span>
                </a>
                
                <a href="https://discord.gg/your-invite" class="card p-6 flex items-center gap-4 hover:scale-105" rel="noopener noreferrer" target="_blank">
                    <div class="p-3 rounded-full bg-blue-500/20">
                        <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                            <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                            <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                        </svg>
                    </div>
                    <span class="font-semibold">Join Discord</span>
                </a>
                
                <a href="https://kimberlynfoster.substack.com" class="card p-6 flex items-center gap-4 hover:scale-105" rel="noopener noreferrer" target="_blank">
                    <div class="p-3 rounded-full bg-green-500/20">
                        <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                        </svg>
                    </div>
                    <span class="font-semibold">Newsletter</span>
                </a>
            </div>
        </nav>
    </main>

    <footer class="text-center py-8 mt-12 text-sm text-muted" role="contentinfo">
        <p>&copy; 2025 Kimberly's Dropathon. All rights reserved.</p>
    </footer>

    <div id="subscribe-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50" role="dialog" aria-labelledby="subscribe-modal-title" aria-modal="true">
        <div class="card p-6 relative max-w-lg w-full">
            <button id="close-subscribe" class="absolute top-4 right-4 text-muted hover:text-primary transition-colors" aria-label="Close modal"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 id="subscribe-modal-title" class="text-2xl font-bold mb-4 text-center brand-font text-gradient">Join the Dropathon!</h2>
            <p class="text-muted mb-6 text-center">Get exclusive updates, behind-the-scenes content, and early access to drops straight to your inbox!</p>
            <div class="bg-white rounded-xl p-1"><iframe src="https://kimberlynfoster.substack.com/embed" width="100%" height="320" style="border:1px solid #EEE; background:white;" frameborder="0" scrolling="no" title="Subscribe to newsletter"></iframe></div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50" role="dialog" aria-labelledby="admin-login-title" aria-modal="true">
        <div class="card p-8 relative max-w-md w-full">
            <button id="close-admin-login" class="absolute top-4 right-4 text-muted hover:text-primary transition-colors" aria-label="Close modal"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 id="admin-login-title" class="text-2xl font-bold mb-6 text-center brand-font text-gradient">Admin Sign In</h2>
            <form id="admin-login-form" class="space-y-4">
                <div><label for="admin-email" class="block text-sm font-medium mb-1">Email</label><input type="email" id="admin-email" class="form-input" required autocomplete="email"></div>
                <div><label for="admin-password" class="block text-sm font-medium mb-1">Password</label>
                    <div class="relative"><input type="password" id="admin-password" class="form-input pr-10" required autocomplete="current-password"><button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-muted" aria-label="Show password"><svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button></div>
                </div>
                <button type="submit" id="admin-login-submit" class="btn btn-primary w-full !mt-6"><span class="loading-spinner hidden"></span><span>Sign In</span></button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast" role="alert" aria-live="polite">
        <svg id="toast-icon" class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="toast-message">Action completed successfully!</span>
        <button class="dismiss-toast ml-auto text-muted hover:text-primary">&times;</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, deleteDoc, updateDoc, increment, serverTimestamp, runTransaction, getDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- TYPE DEFINITIONS (JSDoc) ---
        /**
         * @typedef {object} Drop
         * @property {string} id - The document ID.
         * @property {string} title - The title of the drop.
         * @property {string} description - A short description.
         * @property {string} link - URL to the content.
         * @property {string} contentType - The type of content (e.g., Video, Essay).
         * @property {string} access - Access level ('Free' or 'Paid').
         * @property {string} [imageUrl] - Optional URL for a thumbnail image.
         * @property {number} day - The day of the challenge this was dropped on.
         * @property {number} hearts - The number of hearts.
         * @property {'published' | 'scheduled'} status - The publication status.
         * @property {import("firebase/firestore").Timestamp} timestamp - Firestore server timestamp.
         */

        /**
         * @typedef {object} UIElements
         * @property {HTMLElement} headerDay
         * @property {HTMLElement} headerProgressBar
         * @property {HTMLElement} headerDrops
         * @property {HTMLElement} todayCount
         * @property {HTMLElement} streakCount
         * @property {HTMLElement} headerStreak
         * @property {HTMLElement} freeCount
         * @property {HTMLElement} paidCount
         * @property {HTMLElement} challengeDates
         * @property {HTMLElement} adminPanel
         * @property {HTMLElement} adminSigninBtn
         * @property {HTMLElement} adminSignoutBtn
         * @property {HTMLElement} adminLoginModal
         * @property {HTMLElement} closeAdminLogin
         * @property {HTMLFormElement} adminLoginForm
         * @property {HTMLElement} togglePassword
         * @property {HTMLFormElement} dropForm
         * @property {HTMLElement} publishBtn
         * @property {HTMLElement} publishBtnText
         * @property {HTMLElement} cancelEditBtn
         * @property {HTMLInputElement} searchInput
         * @property {HTMLSelectElement} sortSelect
         * @property {HTMLElement} skeletonLoaders
         * @property {HTMLElement} todaySection
         * @property {HTMLElement} todayDrops
         * @property {HTMLElement} previousSection
         * @property {HTMLElement} previousDrops
         * @property {HTMLElement} loadMoreContainer
         * @property {HTMLElement} emptyState
         * @property {HTMLElement} emptyStateMessage
         * @property {HTMLElement} subscribeBtn
         * @property {HTMLElement} subscribeModal
         * @property {HTMLElement} closeSubscribe
         * @property {HTMLElement} toast
         * @property {HTMLElement} toastMessage
         * @property {HTMLElement} toastIcon
         * @property {HTMLElement} contentFeed
         * @property {HTMLElement} clearDataBtn
         * @property {HTMLElement} dayDotsContainer
         */


        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTd4lvs1lzjKeGu7Ee91lM30-8v88h-ng",
            authDomain: "productivity-tracker-knf13.firebaseapp.com",
            projectId: "productivity-tracker-knf13",
            storageBucket: "productivity-tracker-knf13.appspot.com",
            messagingSenderId: "762035393571",
            appId: "1:762035393571:web:7d474a6a57cc031b860d96"
        };
        const START_DATE = new Date('2025-09-13T00:00:00');
        const END_DATE = new Date('2025-11-26T23:59:59');
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        
        function startOfDay(d) {
            const date = new Date(d);
            date.setHours(0,0,0,0);
            return date;
        }
        
        const TOTAL_DAYS = Math.floor((startOfDay(END_DATE) - startOfDay(START_DATE)) / MS_PER_DAY) + 1;

        const dropsCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/drops`;
        
        // --- UTILITY FUNCTIONS ---
        const getCurrentDay = () => {
            const now = new Date();
            if (now < START_DATE) return 0;
            if (now > END_DATE) return TOTAL_DAYS;
            return Math.floor((startOfDay(now) - startOfDay(START_DATE)) / MS_PER_DAY) + 1;
        };
        const escapeHtml = (str) => {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };
        const toJsDate = (v) => {
            if (!v) return new Date();
            if (v.toDate) return v.toDate();
            return new Date(v);
        };

        // --- INITIALIZATION ---
        let db, auth, currentUser = null, isAdmin = false;
        
        // --- GLOBAL STATE ---
        let allDrops = [], filteredDrops = [];
        let currentFilter = 'all', currentSort = 'newest', searchQuery = '';
        let heartedPosts = JSON.parse(localStorage.getItem('heartedPosts') || '{}');
        let editingDropId = null;
        let unsubscribeDrops;
        let visiblePreviousDrops = 5;
        const DROPS_PER_PAGE = 5;

        // --- DOM ELEMENTS ---
        /** @type {UIElements} */
        const DOMElements = {
            headerDay: document.getElementById('header-day'),
            headerProgressBar: document.getElementById('header-progress-bar'),
            headerDrops: document.getElementById('header-drops'),
            todayCount: document.getElementById('today-count'),
            streakCount: document.getElementById('streak-count'),
            headerStreak: document.getElementById('header-streak'),
            freeCount: document.getElementById('free-count'),
            paidCount: document.getElementById('paid-count'),
            challengeDates: document.getElementById('challenge-dates'),
            adminPanel: document.getElementById('admin-panel'),
            adminSigninBtn: document.getElementById('admin-signin-btn'),
            adminSignoutBtn: document.getElementById('admin-signout-btn'),
            adminLoginModal: document.getElementById('admin-login-modal'),
            closeAdminLogin: document.getElementById('close-admin-login'),
            adminLoginForm: document.getElementById('admin-login-form'),
            togglePassword: document.getElementById('toggle-password'),
            dropForm: document.getElementById('drop-form'),
            publishBtn: document.getElementById('publish-btn'),
            publishBtnText: document.getElementById('publish-btn-text'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            searchInput: document.getElementById('search-input'),
            sortSelect: document.getElementById('sort-select'),
            skeletonLoaders: document.getElementById('skeleton-loaders'),
            todaySection: document.getElementById('today-section'),
            todayDrops: document.getElementById('today-drops'),
            previousSection: document.getElementById('previous-section'),
            previousDrops: document.getElementById('previous-drops'),
            loadMoreContainer: document.getElementById('load-more-container'),
            emptyState: document.getElementById('empty-state'),
            emptyStateMessage: document.getElementById('empty-state-message'),
            subscribeBtn: document.getElementById('subscribe-btn'),
            subscribeModal: document.getElementById('subscribe-modal'),
            closeSubscribe: document.getElementById('close-subscribe'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            toastIcon: document.getElementById('toast-icon'),
            contentFeed: document.getElementById('content-feed'),
            dayDotsContainer: document.getElementById('day-dots-container'),
            scheduleToggle: document.getElementById('schedule-toggle'),
            scheduleOptions: document.getElementById('schedule-options'),
        };

        // --- UI & FEEDBACK FUNCTIONS ---
        const updateProgress = () => {
            const day = getCurrentDay();
            const progress = (day / TOTAL_DAYS) * 100;
            if (DOMElements.headerDay) DOMElements.headerDay.textContent = day;
            if (DOMElements.headerProgressBar) {
                const progressBar = DOMElements.headerProgressBar.querySelector('.header-progress-fill');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                DOMElements.headerProgressBar.setAttribute('aria-valuenow', day);
            }
        };
        
        let toastTimeout;
        const showToast = (message, type = 'success') => {
            clearTimeout(toastTimeout);
            DOMElements.toastMessage.textContent = message;
            DOMElements.toast.className = 'toast'; // Reset classes
            DOMElements.toastIcon.setAttribute('class', 'w-5 h-5');
            
            const icons = {
                success: { path: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`, color: 'text-green-500' },
                error: { path: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`, color: 'text-red-500' },
                warning: { path: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`, color: 'text-yellow-500' }
            };

            DOMElements.toast.classList.add(type);
            DOMElements.toastIcon.innerHTML = icons[type].path;
            DOMElements.toastIcon.classList.add(icons[type].color);
            
            DOMElements.toast.classList.add('show');
            toastTimeout = setTimeout(() => DOMElements.toast.classList.remove('show'), 5000);
        };
        
        let modalOpener;
        const toggleModal = (modal, show, opener) => {
            if (modal) {
                if (show) {
                    modalOpener = opener;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setupFocusTrap(modal);
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    removeFocusTrap();
                }
            }
        };
        
        // --- FORM HANDLING ---
        const resetForm = () => {
            if(DOMElements.dropForm) DOMElements.dropForm.reset();
            editingDropId = null;
            if(DOMElements.publishBtnText) DOMElements.publishBtnText.textContent = 'Drop It!';
            if(DOMElements.cancelEditBtn) DOMElements.cancelEditBtn.classList.add('hidden');
            checkFormValidity();
        };

        const populateFormForEdit = (drop) => {
            editingDropId = drop.id;
            document.getElementById('drop-title').value = drop.title;
            document.getElementById('drop-description').value = drop.description;
            document.getElementById('drop-link').value = drop.link;
            document.getElementById('drop-image').value = drop.imageUrl || '';
            document.getElementById('drop-type').value = drop.contentType;
            document.getElementById('drop-access').value = drop.access;

            DOMElements.publishBtnText.textContent = 'Update Drop';
            DOMElements.cancelEditBtn.classList.remove('hidden');
            window.scrollTo({ top: DOMElements.adminPanel.offsetTop - 80, behavior: 'smooth' });
            checkFormValidity();
        };

        const checkFormValidity = () => {
            if (!DOMElements.dropForm) return;
            const title = document.getElementById('drop-title').value.trim();
            const desc = document.getElementById('drop-description').value.trim();
            const link = document.getElementById('drop-link').value.trim();
            try {
                new URL(link);
                DOMElements.publishBtn.disabled = !(title && desc && link);
            } catch {
                DOMElements.publishBtn.disabled = true;
            }
        };
        
        // --- SAMPLE DATA ---
        async function addSampleDataIfNeeded() {
            const sampleDataFlag = 'sampleDataAdded_v5';
            if (localStorage.getItem(sampleDataFlag)) {
                return;
            }

            const day = getCurrentDay();
            const dropsCollectionRef = collection(db, dropsCollectionPath);
            const snapshot = await getDocs(query(dropsCollectionRef));
            if (!snapshot.empty) {
                localStorage.setItem(sampleDataFlag, 'true'); // Mark as done if db is not empty
                return;
            }


            const sampleDrops = [
                {
                    title: "Today's Welcome Video!",
                    description: "Kicking off the day with a warm welcome and what to expect from today's drops.",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    contentType: "Video",
                    access: "Free",
                    status: 'published',
                    day: day > 0 ? day : 1, 
                    hearts: 25,
                    timestamp: serverTimestamp(),
                    imageUrl: "https://placehold.co/400x300/f472b6/ffffff?text=Welcome!"
                },
                {
                    title: "Deep Dive Podcast on Creative Blocks",
                    description: "Exploring the psychology of creative blocks and how to overcome them. Special guest joins the show.",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    contentType: "Podcast",
                    access: "Paid",
                    status: 'published',
                    day: day > 1 ? day - 1 : 1,
                    hearts: 22,
                    timestamp: serverTimestamp(),
                    imageUrl: "https://placehold.co/400x300/a78bfa/ffffff?text=Podcast"
                },
                {
                    title: "My Favorite Productivity Tools (Essay)",
                    description: "A written piece on the top 5 tools I use every day to stay organized and productive during this challenge.",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    contentType: "Essay",
                    access: "Free",
                    status: 'published',
                    day: day > 2 ? day - 2 : 1,
                    hearts: 8,
                    timestamp: serverTimestamp(),
                    imageUrl: "https://placehold.co/400x300/86efac/ffffff?text=Essay"
                },
                 {
                    title: "Quick Social Media Tip",
                    description: "A short and punchy tip for growing your audience on social media. Easy to implement today!",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    contentType: "Social Post",
                    access: "Free",
                    status: 'published',
                    day: day > 3 ? day - 3 : 1,
                    hearts: 30,
                    timestamp: serverTimestamp(),
                    imageUrl: "https://placehold.co/400x300/fde047/ffffff?text=Social"
                },
                {
                    title: "How to Set Up Your Workspace for Creativity",
                    description: "A step-by-step tutorial on organizing your physical and digital space to foster creativity and focus.",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    contentType: "Tutorial",
                    access: "Paid",
                    status: 'published',
                    day: day > 4 ? day - 4 : 1,
                    hearts: 18,
                    timestamp: serverTimestamp(),
                    imageUrl: "https://placehold.co/400x300/34d399/ffffff?text=Tutorial"
                }
            ];
            
            const batch = writeBatch(db);
            sampleDrops.forEach((drop) => {
                const docRef = doc(collection(db, dropsCollectionPath));
                batch.set(docRef, drop);
            });
            await batch.commit();

            localStorage.setItem(sampleDataFlag, 'true');
            console.log("Sample data added.");
        }


        // --- RENDER FUNCTIONS ---
        const createDropCard = (drop) => {
            const isHearted = heartedPosts[drop.id];
            const dropDate = toJsDate(drop.timestamp);
            const time = dropDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

            const fallbackImage = `https://placehold.co/400x300/7c3aed/ffffff?text=${encodeURIComponent(drop.contentType)}`;
            const imageUrl = drop.imageUrl || fallbackImage;

            const adminButtons = isAdmin ? `
                <button class="edit-btn text-muted hover:text-accent" data-id="${drop.id}" aria-label="Edit drop">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                </button>
                <button class="delete-btn text-muted hover:text-error" data-id="${drop.id}" aria-label="Delete drop">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            ` : '';
            
            const card = document.createElement('div');
            card.className = 'card flex flex-col md:flex-row relative';
            card.dataset.id = drop.id;

            const titleElement = document.createElement('h3');
            titleElement.className = 'text-2xl font-semibold leading-tight hover:text-accent transition-colors brand-font title-glow';
            const linkElement = document.createElement('a');
            linkElement.href = drop.link;
            linkElement.target = '_blank';
            linkElement.rel = 'noopener noreferrer';
            linkElement.className = 'inline-flex items-center gap-1.5';
            linkElement.textContent = drop.title;
            linkElement.innerHTML += ` <svg class="w-4 h-4 opacity-50 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
            titleElement.appendChild(linkElement);

            const descriptionElement = document.createElement('p');
            descriptionElement.className = 'text-base text-muted line-clamp-2';
            descriptionElement.textContent = drop.description;

            card.innerHTML = `
                <div class="md:w-48 aspect-[4/3] flex-shrink-0">
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(drop.title)}" class="w-full h-full object-cover" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='${fallbackImage}';">
                </div>
                <div class="flex-1 p-4 md:p-5 flex flex-col">
                    <span class="tag ${drop.access === 'Paid' ? 'tag-paid' : 'tag-free'} absolute top-3 right-3">${drop.access}</span>
                    <div class="flex-grow space-y-2 mt-4">
                        
                    </div>
                     <p class="text-xs text-muted mt-4">Day ${drop.day} â€¢ ${drop.contentType} â€¢ ${time}</p>
                    <div class="flex items-center gap-3 mt-4 pt-3 border-t border-white/10">
                         <button class="heart-btn flex items-center gap-1 ${isHearted ? 'text-heart hearted' : 'text-muted hover:text-heart'}" data-id="${drop.id}" aria-label="${isHearted ? 'Remove heart' : 'Add heart'}">
                            <svg class="w-4 h-4" fill="${isHearted ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.25l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.5l-1.318-1.182a4.5 4.5 0 00-6.364 0z"></path></svg>
                            <span class="font-mono">${drop.hearts || 0}</span>
                        </button>
                        <button class="share-btn text-sm text-muted hover:text-primary ml-2" data-link="${escapeHtml(drop.link)}" data-title="${escapeHtml(drop.title)}">
                            Share
                        </button>
                        <div class="ml-auto flex items-center gap-3">
                           ${adminButtons}
                        </div>
                    </div>
                </div>
            `;
            const contentContainer = card.querySelector('.flex-grow.space-y-2');
            contentContainer.appendChild(titleElement);
            contentContainer.appendChild(descriptionElement);

            return card;
        };
        
        const renderDrops = () => {
            if (DOMElements.skeletonLoaders) {
                DOMElements.skeletonLoaders.classList.add('hidden');
                DOMElements.contentFeed.setAttribute('aria-busy', 'false');
            }

            const day = getCurrentDay();
            const todaysDrops = filteredDrops.filter(d => d.day === day);
            const previousDrops = filteredDrops.filter(d => d.day < day);

            // Update stats
            const publishedDrops = allDrops.filter(d => d.status === 'published');
            const publishedDropsCount = publishedDrops.length;
            
            if (DOMElements.headerDrops) DOMElements.headerDrops.textContent = publishedDropsCount;
            if (DOMElements.todayCount) DOMElements.todayCount.textContent = todaysDrops.length;
            if (DOMElements.freeCount) DOMElements.freeCount.textContent = publishedDrops.filter(d => d.access === 'Free').length;
            if (DOMElements.paidCount) DOMElements.paidCount.textContent = publishedDrops.filter(d => d.access === 'Paid').length;
            const daysWithDrops = new Set(publishedDrops.map(d => d.day)).size;
            if (DOMElements.streakCount) DOMElements.streakCount.textContent = daysWithDrops;
            if (DOMElements.headerStreak) DOMElements.headerStreak.textContent = daysWithDrops;

            // Render Today's drops
            if (DOMElements.todaySection) DOMElements.todaySection.classList.toggle('hidden', todaysDrops.length === 0);
            if (DOMElements.todayDrops) {
                DOMElements.todayDrops.innerHTML = '';
                todaysDrops.forEach(d => DOMElements.todayDrops.appendChild(createDropCard(d)));
            }

            // Render Previous Drops with "Load More"
            const previousToShow = previousDrops.slice(0, visiblePreviousDrops);
            if (DOMElements.previousSection) DOMElements.previousSection.classList.toggle('hidden', previousToShow.length === 0);
            if (DOMElements.previousDrops) {
                DOMElements.previousDrops.innerHTML = '';
                 previousToShow.forEach(d => DOMElements.previousDrops.appendChild(createDropCard(d)));
            }
            
            if (DOMElements.loadMoreContainer) {
                DOMElements.loadMoreContainer.innerHTML = ''; 
                if (previousDrops.length > visiblePreviousDrops) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.textContent = 'Load More Drops';
                    loadMoreBtn.className = 'btn btn-secondary';
                    loadMoreBtn.onclick = () => {
                        visiblePreviousDrops += DROPS_PER_PAGE;
                        renderDrops();
                    };
                    DOMElements.loadMoreContainer.appendChild(loadMoreBtn);
                }
            }

            if (filteredDrops.length === 0 && todaysDrops.length === 0) {
                if (DOMElements.emptyState) DOMElements.emptyState.classList.remove('hidden');
                if (DOMElements.emptyStateMessage) DOMElements.emptyStateMessage.textContent = (searchQuery || currentFilter !== 'all') ? 'No drops found matching your criteria.' : 'No drops yet. Check back soon!';
            } else {
                if (DOMElements.emptyState) DOMElements.emptyState.classList.add('hidden');
            }
            updateItemListSchema(publishedDrops.slice(0, 10)); // Update schema with top drops
        };
        
        // --- DATA LOGIC ---
        const applyFiltersAndSort = () => {
            visiblePreviousDrops = DROPS_PER_PAGE; // Reset pagination on filter change
            const publishedDrops = allDrops.filter(d => d.status === 'published');
            filteredDrops = publishedDrops.filter(drop => {
                const search = searchQuery.toLowerCase();
                const matchesSearch = !search || drop.title.toLowerCase().includes(search) || drop.description.toLowerCase().includes(search);
                const matchesFilter = currentFilter === 'all' || drop.contentType === currentFilter;
                return matchesSearch && matchesFilter;
            });

            filteredDrops.sort((a, b) => {
                const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                
                switch (currentSort) {
                    case 'oldest': return timeA - timeB;
                    case 'most-loved': return (b.hearts || 0) - (a.hearts || 0);
                    default: return timeB - timeA;
                }
            });
            renderDrops();
            renderDayDots();
        };

        const setupFirestoreListener = (isAdminFlag) => {
            if (unsubscribeDrops) unsubscribeDrops(); 
            
            const dropsCollectionRef = collection(db, dropsCollectionPath);

            const q = isAdminFlag 
                ? query(dropsCollectionRef)
                : query(dropsCollectionRef, where('status', '==', 'published'));

            unsubscribeDrops = onSnapshot(q, (snapshot) => {
                allDrops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFiltersAndSort();
            }, (error) => {
                console.error("Firestore listener error:", error);
                showToast("Error loading drops. Please refresh.", "error");
            });
        };

        const updateItemListSchema = (drops) => {
            const itemListElement = {
                "@context": "https://schema.org",
                "@type": "ItemList",
                "itemListElement": drops.map((drop, index) => ({
                    "@type": "ListItem",
                    "position": index + 1,
                    "url": drop.link,
                    "name": drop.title
                }))
            };
            document.getElementById('itemListSchema').textContent = JSON.stringify(itemListElement);
        };

        const renderDayDots = () => {
            const currentDay = getCurrentDay();
            if (DOMElements.dayDotsContainer) {
                DOMElements.dayDotsContainer.innerHTML = '';
                for (let i = 1; i <= TOTAL_DAYS; i++) {
                    const dot = document.createElement('div');
                    dot.className = `w-2 h-2 rounded-full ${i < currentDay ? 'bg-accent' : 'bg-muted'}`;
                    DOMElements.dayDotsContainer.appendChild(dot);
                }
            }
        }
        
        // --- EVENT LISTENERS & HANDLERS ---
        const handleAdminFormSubmit = async (e) => {
            e.preventDefault();
            const dropData = {
                title: document.getElementById('drop-title').value.trim(),
                description: document.getElementById('drop-description').value.trim(),
                link: document.getElementById('drop-link').value.trim(),
                imageUrl: document.getElementById('drop-image').value.trim(),
                contentType: document.getElementById('drop-type').value,
                access: document.getElementById('drop-access').value,
            };
            
            try { new URL(dropData.link) } catch { showToast("Please enter a valid link.", "error"); return; }
            if (dropData.imageUrl) { try { new URL(dropData.imageUrl) } catch { showToast("Please enter a valid image URL.", "error"); return; } }
            
            const btnSpinner = DOMElements.publishBtn.querySelector('.loading-spinner');
            btnSpinner.classList.remove('hidden');
            DOMElements.publishBtn.disabled = true;

            try {
                if (DOMElements.scheduleToggle && DOMElements.scheduleToggle.checked) {
                    const date = document.getElementById('schedule-date').value;
                    const time = document.getElementById('schedule-time').value;
                    if (!date || !time) throw new Error("Please select a valid schedule date and time.");
                    
                    dropData.status = 'scheduled';
                    dropData.scheduledFor = new Date(`${date}T${time}`).toISOString();
                    dropData.timestamp = null; 
                } else {
                    dropData.status = 'published';
                    dropData.day = getCurrentDay();
                    dropData.timestamp = serverTimestamp();
                }
                
                if (editingDropId) {
                    await updateDoc(doc(db, dropsCollectionPath, editingDropId), dropData);
                    showToast('Drop updated successfully!');
                } else {
                    dropData.hearts = 0; 
                    await addDoc(collection(db, dropsCollectionPath), dropData);
                    showToast('Drop added successfully!');
                }
                resetForm();
            } catch (error) {
                console.error("Error submitting drop:", error);
                showToast(error.message || "Could not save drop.", "error");
            } finally {
                btnSpinner.classList.add('hidden');
                checkFormValidity();
            }
        };

        const handleContentClick = async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const dropId = btn.dataset.id;
            
            if (btn.classList.contains('share-btn')) {
                const { link, title } = btn.dataset;
                 if (navigator.share) {
                    try { await navigator.share({ title, url: link }); } catch (err) { console.log('Share cancelled'); }
                } else {
                    navigator.clipboard.writeText(link);
                    showToast('Link copied to clipboard!');
                }
                return;
            }

            if (!dropId) return;

            if (btn.classList.contains('delete-btn')) {
                if (confirm('Delete this drop? This cannot be undone.')) {
                    await deleteDoc(doc(db, dropsCollectionPath, dropId));
                    showToast('Drop deleted.');
                }
            } else if (btn.classList.contains('edit-btn')) {
                const dropToEdit = allDrops.find(d => d.id === dropId);
                if (dropToEdit) populateFormForEdit(dropToEdit);
            } else if (btn.classList.contains('heart-btn')) {
                if (!currentUser || currentUser.isAnonymous) {
                    showToast('Please sign in to heart posts.', 'warning');
                    return;
                }

                const heartRef = doc(db, `${dropsCollectionPath}/${dropId}/hearts/${currentUser.uid}`);
                const dropRef = doc(db, dropsCollectionPath, dropId);

                await runTransaction(db, async (transaction) => {
                    const heartDoc = await transaction.get(heartRef);
                    if (heartDoc.exists()) {
                        // Unhearting
                        transaction.delete(heartRef);
                        transaction.update(dropRef, { hearts: increment(-1) });
                        delete heartedPosts[dropId];
                    } else {
                        // Hearting
                        transaction.set(heartRef, { timestamp: serverTimestamp() });
                        transaction.update(dropRef, { hearts: increment(1) });
                        heartedPosts[dropId] = true;
                    }
                });
                
                localStorage.setItem('heartedPosts', JSON.stringify(heartedPosts));
            }
        };

        const handleAdminLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const btnSpinner = DOMElements.adminLoginForm.querySelector('.loading-spinner');
            btnSpinner.classList.remove('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                toggleModal(DOMElements.adminLoginModal, false);
                showToast('Signed in successfully!');
            } catch (error) {
                showToast('Invalid credentials.', 'error');
            } finally {
                btnSpinner.classList.add('hidden');
            }
        };

        // --- AUTH STATE CHANGE ---
        
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                await addSampleDataIfNeeded(); // Add sample data on first load

                if (auth) {
                    onAuthStateChanged(auth, async (user) => {
                        currentUser = user;
                        if (user && !user.isAnonymous) {
                            const idTokenResult = await user.getIdTokenResult(true); 
                            isAdmin = !!idTokenResult.claims.admin;
                        } else {
                            isAdmin = false;
                        }
                        
                        document.body.classList.toggle('is-admin', isAdmin);
                        DOMElements.adminPanel.classList.toggle('hidden', !isAdmin);
                        DOMElements.adminSigninBtn.classList.toggle('hidden', isAdmin);
                        DOMElements.adminSignoutBtn.classList.toggle('hidden', !isAdmin);
                        
                        setupFirestoreListener(isAdmin);
                        applyFiltersAndSort();
                    });
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showToast("Error connecting to database", "error");
            }
        }
        
        function setupFocusTrap(modal) {
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            modal.addEventListener('keydown', (e) => {
                if (e.key !== 'Tab') return;
                if (e.shiftKey) { // shift + tab
                    if (document.activeElement === firstFocusableElement) {
                        lastFocusableElement.focus();
                        e.preventDefault();
                    }
                } else { // tab
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        e.preventDefault();
                    }
                }
            });
            if(firstFocusableElement) {
               firstFocusableElement.focus();
            }
        }

        function removeFocusTrap() {
            if(modalOpener) {
                modalOpener.focus();
                modalOpener = null;
            }
        }


        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();

            DOMElements.challengeDates.textContent = `${START_DATE.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} â€” ${END_DATE.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            
            updateProgress();
            setInterval(updateProgress, 60000);

            if(DOMElements.dropForm) {
                DOMElements.dropForm.addEventListener('submit', handleAdminFormSubmit);
                DOMElements.dropForm.addEventListener('input', checkFormValidity);
            }
            
            document.getElementById('content-feed').addEventListener('click', handleContentClick);
            
            if(DOMElements.searchInput) {
                 DOMElements.searchInput.addEventListener('input', debounce(() => {
                    searchQuery = DOMElements.searchInput.value;
                    applyFiltersAndSort();
                }, 300));
            }
           
            if(DOMElements.sortSelect) {
                 DOMElements.sortSelect.addEventListener('change', (e) => {
                    currentSort = e.target.value;
                    applyFiltersAndSort();
                });
            }
           
            document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                e.currentTarget.classList.add('active');
                currentFilter = e.currentTarget.dataset.filter;
                applyFiltersAndSort();
            }));

            if(DOMElements.subscribeBtn) DOMElements.subscribeBtn.addEventListener('click', (e) => toggleModal(DOMElements.subscribeModal, true, e.currentTarget));
            if(DOMElements.closeSubscribe) DOMElements.closeSubscribe.addEventListener('click', () => toggleModal(DOMElements.subscribeModal, false));
            if(DOMElements.adminSigninBtn) DOMElements.adminSigninBtn.addEventListener('click', (e) => toggleModal(DOMElements.adminLoginModal, true, e.currentTarget));
            if(DOMElements.closeAdminLogin) DOMElements.closeAdminLogin.addEventListener('click', () => toggleModal(DOMElements.adminLoginModal, false));
            if(DOMElements.adminSignoutBtn) DOMElements.adminSignoutBtn.addEventListener('click', () => signOut(auth));
            if(DOMElements.adminLoginForm) DOMElements.adminLoginForm.addEventListener('submit', handleAdminLogin);
            if(DOMElements.togglePassword) {
                DOMElements.togglePassword.addEventListener('click', () => {
                    const pwField = document.getElementById('admin-password');
                    pwField.type = pwField.type === 'password' ? 'text' : 'password';
                });
            }
            
            if(DOMElements.cancelEditBtn) DOMElements.cancelEditBtn.addEventListener('click', resetForm);
            if(DOMElements.clearDataBtn) {
                 DOMElements.clearDataBtn.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete ALL drops? This cannot be undone.')) {
                        const dropsCollectionRef = collection(db, dropsCollectionPath);
                        const snapshot = await getDocs(query(dropsCollectionRef));
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        localStorage.removeItem('sampleDataAdded_v5');
                        showToast('All data cleared.');
                    }
                });
            }
            if(DOMElements.scheduleToggle) {
                 DOMElements.scheduleToggle.addEventListener('change', (e) => {
                    if (DOMElements.scheduleOptions) {
                        DOMElements.scheduleOptions.classList.toggle('hidden', !e.target.checked);
                    }
                });
            }
            DOMElements.toast.addEventListener('click', (e) => {
                if (e.target.classList.contains('dismiss-toast')) {
                    DOMElements.toast.classList.remove('show');
                }
            });
        });

    </script>
</body>
</html>

